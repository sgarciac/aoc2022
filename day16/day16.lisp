(ql:quickload "graph")
(ql:quickload "cl-ppcre")

(defstruct world valves rates paths)
(defstruct situation open-valves minute current-valve)

(defun create-best-known () (make-hash-table))

(defun situation-key (situation)
  "Gets a canonical key to store a situation in a hashmap"
  (let ((sorted-valves (sort (mapcar #'symbol-name (situation-open-valves situation)) #'string>)))
    (intern (format nil "狺狺幄箫螋邃鲠祧弩箝趱狒轱瞽黹铛翦箝趱狒轱瞟簌礅镬钺礤箝趱狒轱瞽沲蝌孱舡鲠祧箝趱狒轱瞟┅┅ㄤ彐躅箝趱狒轱瞽忮篝箝趱狒轱忮篝腩秣瞟ㄧ弭栳箬箝趱狒轱瞽脲箝趱狒轱瞟忮篝腩秣瞟ㄤ彐躅翳弪弩羼踽飙矧忮趑弪箝趱狒轱蝈戾狍邃忮篝腩秣瞟溟麇犰蝈徜鲩箝翦箝趱狒轱鏖翳翳筢礤铛礅弪镦镳孱鲠祧弩轭翳筢礤痫箝糸镱轭戾篌矧羼踽糸礤竣祜镳骘骝镯箝趱狒轱瞽黹铛翦箝趱狒轱瞟滹黝麸滹戾è怆箝趱狒轱瞽忮篝磲脲箝趱狒轱猴疱瞽鲠祧弩箝趱狒轱瞽镳孱鲠祧弩箝趱狒轱瞟恒躜蝈铘鲠祧箝趱狒轱瞽沲蝌孱舡鲠祧箝趱狒轱瞟喉轭豸椹忮篝腩秣瞟┅麒孱ㄡ钿怆窘怆蝈戾狍邃蝈趱蝾骝镯翳弪弩羼踽飙矧忮趑弪舂┅┅ㄤ彐躅躔溽翦忮篝腩秣ㄢ弩舡腩秣箝趱狒轱蝈戾狍邃戾è沲蝌孱舡忮篝箝趱狒轱瞽忮篝箝趱狒轱忮篝腩秣瞟┅麒孱矧铒沲蝌孱舡忮篝蝈戾狍邃沲蝌孱舡忮篝┅箦翩ㄧ弭栳箬箝趱狒轱瞽脲箝趱狒轱瞟忮篝腩秣瞟蝈戾狍邃┅┅ㄤ彐躅泸遽翦屙痿黠蜢ī磲脲黠蜢忽犰鲥Ж候狒弩磲脲栳箬翎忪濠吼狒梵磲脲轭篝犷沐х蜥痂汉珧狃瑭┅ㄤ彐躅蝈徜轭瘐ㄦ殪孱犴濠鏖翳镳孱骈戾篝蝈犴骈戾钺礤祜镳鏖翳黠蜢ㄣ蝈狒瀛屙痿黠蜢洎骘扉铄蝈徜扉铄篝蝈犴铋飑麒殪铒弪镳戾铉翳扉铄┅骘疳螋ㄣ飙痧泸搴后痨轸扉铄泔祆邈糸铉疳螋滹戾舄è鲠祧蝈徜骝镯篝蜷铉铘疳螋螬┅蜥翦蝈徜骝镯篝蜷铉ㄣ徜ㄣ飙痧泸搴后痨轸③唤茛铘疳螋螬┅┅ㄤ弩糸钺糸镱磲疸狎灬礅溽疳螋蝈徜骝镯篝蜷铉蝈盹鲥＼疳螋┅篚怏羼疳螋供┅瘐箬鲠祧黠蜢洵鲠祧弩黠蜢洎箦翩ㄧ弭栳箬鲠祧黠蜢洵蜥翦黠蜢洎蜥翦祜镳骘溴篝轭狒轱轭溴篝轭狒轱铙滹ㄧ蜥痂汉徜洵邃珏黠蜢洵疳翳黠蜢洎扉篝鲠祧溴篝轭狒轱瞟┅骈钺祆蝈趱蝾黠蜢洎┅ㄤ彐躅玑蟓蝻躅黠蜢鲠祧弩祜镳骘鲠祧轭鲠祧弩篚眄轭ㄧ弭栳箬鲠祧黠蜢洵蜥翦黠蜢洎┅ㄤ彐躅铄舡徙糸镱黠蜢沲蝌孱舡鲠祧镳孱鲠祧弩戾è邃珏磲疸狎灬礅溽ㄥ溏濠ㄩㄥㄣ狎邃珏沲蝌孱舡鲠祧濠ㄣ徜邃珏ㄣ狎邃珏┅ㄧ蜥痂汉铒溴邃珏黠蜢洵疳翳黠蜢洎沲蝌孱舡鲠祧濠┅ㄩ矧ㄦ轭沲蝌孱舡鲠祧镳孱鲠祧弩弪镳ㄧ弭栳箬沲蝌孱舡鲠祧黠蜢洵蜥翦黠蜢洎┅邃珏ㄣ镱合信邃珏螬┅ㄤ彐躅珏舡忮篝黠蜢沲蝌孱舡鲠祧黹铛翦轭轸獒祆蝈戾狍邃镳孱鲠祧弩磲徙糸镱忮篝腩秣⒁弭躜铙翳忮篝疳翳犷翳泔蝌弩痫钿轭蝈戾狍邃玑骘黠蜢洮篝狎糸铉狒咩躜蝈铘鲠祧暹痱弼轱躞蝈戾狍邃玑唛铋糸犰禊唑屐遽箦溥扉篝镦唢疱瞽鲠祧弩犷磲轫蹴铛礅弪镦徙糸镱唔狲徙糸镱筮翳铛礅弪镦唔轭豸弩轶羼踽麸翳戾铉翳镦痱弼轱躞徙糸镱螽唠铒黝哜弩暨泔铘衢铙珈镡犰栳箬翎忪磲痧轭鲠祧弩黹铛翦犷翳珧遽翦篝蝈戾狍邃玑腩秣骘翳狒疳轵涉翳沲蝌孱箝趱狒轱栳忮篝珧遽翦蝈戾狍邃玑翳犷痱弼轱躞蝈戾狍邃翳骢钽糸镱蝈趱蝾耗帕倪盼蘑换殒糸礤轶躔徜铄蝻躅镦玑犷蝈趱蝾铒徙糸镱犷蝻躅镦蝈戾狍邃玑麒孱黹铛翦磲徙糸镱螬花痱轭㈠钿蝈趱蝾骝镯珏舡忮篝鲠祯弩铋ㄧ狍蝻躅黠蜢镳孱鲠祧弩┅┅换遗恼门闲陨衔优迷上换涉麇栳鲥犰蝈徜忮孱轭翳轶箝趱狒轱轶翳筢礤矧羼踽糸礤篝镳鲩箝糸铉箝钽麇换犰蝈徜腩秣箫礤翳轭忮趑弪戾è溴徜孱翳弪弩羼踽飙矧忮趑弪磲脲箝趱狒轱恒躜蝈铘鲠祧沲蝌孱舡鲠祧猴疱瞽鲠祧弩镳孱鲠祧弩喉轭豸黹铛翦螬轭轸獒祆蝈戾狍邃忮篝腩秣瞟┅躔溽翦忮篝腩秣忮篝腩秣磲脲箝趱狒轱恒躜蝈铘鲠祧沲蝌孱舡鲠祧猴疱瞽鲠祧弩镳孱鲠祧弩喉轭豸黹铛翦螬轭轸獒祆蝈戾狍邃麒孱溴徜孱蝈趱蝾骝镯珏舡忮篝耗帕倪盼末┅戾è铄舡徙糸镱铄舡徙糸镱黠蜢沲蝌孱舡鲠祧镳孱鲠祧弩┅祜镳鏖翳铄舡忮篝徙糸镱耗帕倪盼鏖翳铄舡忮篝蝈戾狍邃鏖翳铄舡忮篝徙糸镱铋骘徙糸镱轭铄舡徙糸镱滹眭祠轲戾鲠祯瀛忾钿ㄡ泗轱铙蝈戾狍邃ㄧ弭忮篝黠蜢ㄩㄥ徙糸镱合信惟沲蝌孱舡鲠祧徙糸镱ū黹铛翦螬换铒糸鲥麇腩秣犰蝈徜翳狒殒合信轶轭翳扉篝翳鲠祧轶铒弭镳孱换麇滹瞌铄邃麸躞徜觑轭ǐ轭轸獒祆蝈戾狍邃ㄧ狍蝻躅黠蜢ㄩㄥ徙糸镱合信惟ㄣ镱沲蝌孱舡鲠祧镳孱鲠祧弩镳孱鲠祧弩┅ㄩㄥ徙糸镱合信惟ㄣ镱沲蝌孱舡鲠祧镳孱鲠祧弩镳孱鲠祧弩磲徙糸镱忮篝腩秣瞟花骘蝽狒㈠痨矧轭徙糸镱骝镯俩窿ア沲蝌孱舡鲠祧徙糸镱蝈戾狍邃铄舡忮篝蝈戾狍邃镳孱鲠祧弩麒孱ㄡ钿铒ㄥ徙糸镱耗帕倪盼末蝈戾狍邃铄舡忮篝蝈戾狍邃┅箦翩铄舡忮篝徙糸镱徙糸镱箦翩铄舡忮篝徙糸镱徙糸镱螬箦翩铄舡忮篝蝈戾狍邃蝈戾狍邃┅骈钺祆痱镧蝈趱蝾ㄩ铒ㄥ铄舡忮篝徙糸镱耗帕倪盼末鲠祯弩ㄣ镱铄舡忮篝徙糸镱铄舡忮篝徙糸镱螬ǐ铄舡忮篝蝈戾狍邃ㄧ狍蝻躅黠蜢镳孱鲠祧弩┅耗帕倪盼末┅┅戾è黠蜢蝈徜轭瘐㈤铕豸豇簪┅ㄧ弭忮篝黠蜢ЯЖ补ㄣ蝈狒瀛忮篝腩秣瞟┅